<html>
<head>
<style>
#progressBar {
  position: relative;
  width: 100%;
  height: 10px;
  background-color: #101090;
}
#progressFill {
  position: absolute;
  width: 10%;
  height: 100%;
  background-color: #4CAF50;
}
</style>
<script src="jquery.js"></script>
<script src="URI.js"></script>
<script>

function Timer(){
  var elapsedTime = 0;
  var triggerTime = 0;
  this.start = function() { triggerTime = Date.now(); };
  this.stop = function() {
    elapsedTime += this.getTime();
    triggerTime = 0;
  };
  this.getTime = function() {
    return (this.isOn())? (Date.now()-triggerTime) : 0;
  };
  this.getTotal = function() { return elapsedTime + this.getTime(); };
  this.isOn = function() { return (triggerTime != 0); }
}

function msToHours(ms){
  return (((ms/1000.0 /*seconds*/) / 60.0) /*minutes*/ / 60.0 /*hours*/);
}

/** Responsible for local state in a job work session */
function Session(expectedPPH, transmit){
  var partsLogged = 0;
  var timeLastPart = 0;
  var timer = new Timer();
  this.logPart = function () {
    if(!timer.isOn()) return;
    timeLastPart = Date.now();
    partsLogged += 1;
    this.sendUpdate();
  };
  this.sendUpdate = function () {
    transmit({count: partsLogged, elapsed: timer.getTotal()});
  };
  this.start = function () {
    timer.start();
    timeLastPart = Date.now();
  };
  this.stop = function () {
    timer.stop();
  };
  this.actualPPH = function() {
    var hours = msToHours(timer.getTotal());
    return (hours==0) ? 0.0 : (partsLogged/hours);
  };
  this.expectedPartCount = function () {
    return expectedPPH * msToHours(timer.getTotal());
  };
  this.percentageNext = function () {
    var delta = msToHours(Date.now() - timeLastPart);
    var nextPartPercentage = Math.min(expectedPPH*delta, 1.0) * 100;
    return (this.isOn()) ? nextPartPercentage : 0.0;
  };
  this.isOn = function () { return timer.isOn(); };
  this.partsLogged = function () { return partsLogged; };
}

var uri = new URI(window.location);
var MO = uri.search(true)["MO"];
var op = uri.search(true)["opnum"];

function showStartup(){
  $("#login").show();
  $("#working").hide();
}

function hideStartup(){
  $("#login").hide();
  $("#working").show();
}

/**
 * Initializes UI interaction with the websocket's job session
 * @return A work session object supporting a "shutdown" command that stops
 *             internal timers
 */
function startWork(expectedPPH, socket){
  function sendToSocket(data){
    socket.send(JSON.stringify(data));
  }

  function updateCompleted(){
    $("#Completed").text(session.partsLogged());
    $("#ActualPPH").text(session.actualPPH().toFixed(2));
  }

  function updateExpected(){
    $("#Expected").text(session.expectedPartCount().toFixed(0));
    $("#progressFill").width(session.percentageNext()+'%');
  }

  var session = new Session(expectedPPH, sendToSocket);
  var refresh = window.setInterval(updateExpected, 50);
  var heartbeat = window.setInterval(function(){session.sendUpdate()},30000);

  $("#Part").click(function(){
    session.logPart();
    updateCompleted();
  });

  $("#Toggle").click(function(){
    if(session.isOn()){
      session.stop();
      $(this).text("Start");
      $("#Part").prop("disabled",true);
    } else {
      session.start();
      $(this).text("Stop");
      $("#Part").prop("disabled",false);
    }
  });

  updateCompleted();
  updateExpected();
  hideStartup();

  return {
    shutdown: function() {
      window.clearInterval(refresh);
      window.clearInterval(heartbeat);
    }
  };
}

$(document).ready(function(){
  showStartup();
  $( "#loginForm" ).submit(function(event) {
    event.preventDefault();

    // Read input fields
    var emp = $(this).find("input[name='Employee']").val();
    var crw = $(this).find("input[name='CrewSize']").val();

    // Update Employee field on the page
    $("#Employee").text(emp)

    // Construct websocket request address
    var socketAddress = "ws://"+location.hostname+":"+location.port+"/job?"
                        +$.param({MO: MO, opnum: op, empl: emp, crew: crw});

    //Startup the websocket. The first message will be the expected session PPH
    var webSocket = new WebSocket(socketAddress);
    var workSession;
    webSocket.onmessage = function (event) {
      var expectedPPH = Number(event.data);
      $("#ExpectedPPH").text(expectedPPH.toFixed(2));
      workSession = startWork(expectedPPH, webSocket);
      webSocket.onmessage = function (event) { console.log("Received "+data); }
    };
    webSocket.onclose = function(event) {
      showStartup();
      if(workSession != null) workSession.shutdown();
      alert("Connection Failure");
    }
  });
});
</script>
</head>
<body>

<div id="login">
  <form id="loginForm">
    <input type="text" name="Employee" placeholder="Employee Number">
    <input type="text" name="CrewSize" placeholder="Crew Size">
    <input type="submit" value="Enter">
  </form>
</div>

<div id="working">
  Employee: <span id="Employee">0</span> <br>
  Completed: <span id="Completed">0</span> <br>
  Expected: <span id="Expected">0</span> <br>
  Actual PPH: <span id="ActualPPH">0</span> <br>
  Expected PPH: <span id="ExpectedPPH">0</span> <br>

  <div id="progressBar">
    <div id="progressFill">
    </div>
  </div>

  <button id="Part" disabled>Count Up</button><br>
  <button id="Toggle">Start</button><br>
</div>

</body>
</html>

