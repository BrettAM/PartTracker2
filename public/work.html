<html>
<head>
<style>
#progressBar {
  position: relative;
  width: 100%;
  height: 10px;
  background-color: #101090;
}
#progressFill {
  position: absolute;
  width: 10%;
  height: 100%;
  background-color: #4CAF50;
}
</style>
<script src="jquery.js"></script>
<script src="URI.js"></script>
<script>
var uri = new URI(window.location);
var MO = uri.search(true)["MO"];
var op = uri.search(true)["opnum"];

var partsLogged;
var expectedPPH;
var elapsedTime;
var timer;
var lastPart;

function initializeJob(){
  partsLogged = 0
  expectedPPH = 0.0
  elapsedTime = 0
  timer = 0
  lastPart = 0
}

function startTimer(){
  timer = Date.now();
}

function stopTimer(){
  elapsedTime += getTimer();
  timer = 0;
}

function getTimer(){
  if(!timerOn()) return 0;
  return (Date.now() - timer);
}

function timerOn(){
  return (timer != 0);
}

function currentElapsedTime(){
  return elapsedTime+getTimer();
}

function logPart(){
  lastPart = Date.now();
  partsLogged += 1;
  updateDisplay();
}

function msToHours(ms){
  return (((ms/1000.0 /*seconds*/) / 60.0) /*minutes*/ / 60.0 /*hours*/);
}

function updateDisplay(){
  var hours = msToHours(currentElapsedTime());
  var delta = msToHours(Date.now() - lastPart);
  var nextPartPercentage = Math.min(expectedPPH*delta, 1.0) * 100;

  $("#Completed").text(partsLogged);
  $("#Expected").text((expectedPPH*hours).toFixed(0));
  $("#ActualPPH").text(hours==0 ? 0.0 : (partsLogged/hours).toFixed(2) );
  $("#progressFill").width(timerOn() ? nextPartPercentage+'%' : 0);
}

function showStartup(){
  $("#login").show();
  $("#working").hide();
}

function hideStartup(){
  $("#login").hide();
  $("#working").show();
}

$(document).ready(function(){
  showStartup();

  $( "#loginForm" ).submit(function(event) {
    event.preventDefault();
    initializeJob();

    var emp = $(this).find("input[name='Employee']").val();
    var crw = $(this).find("input[name='CrewSize']").val();
    var socketAddress = "ws://"+location.hostname+":"+location.port+"/job?"
                        +$.param({MO: MO, opnum: op, empl: emp, crew: crw});

    // Update Employee field on the page
    $("#Employee").text(emp)

    // Start graphic update timer
    var refresh = window.setInterval(updateDisplay, 50);

    //Startup the websocket. The first message will be the expected session PPH
    var webSocket = new WebSocket(socketAddress);
    webSocket.onmessage = function (event) {
      expectedPPH = Number(event.data)
      $("#ExpectedPPH").text(expectedPPH)
      hideStartup();

      webSocket.onmessage = function (event) { console.log("Received "+data); }
    };
    webSocket.onclose = function(event) {
      showStartup();
      window.clearInterval(refresh);
      alert("Connection Failure");
    }

    var sendUpdate = function () {
      if(webSocket.readyState == WebSocket.OPEN)
        webSocket.send(
          JSON.stringify({count: partsLogged, elapsed: currentElapsedTime()})
        );
    };

    $("#Part").click(function(){
      if(timerOn()){
        logPart();
        sendUpdate();
      }
    });
    $("#Start").click(function(){
      if(!timerOn()){
        startTimer();
        lastPart = Date.now();
      }
    });
    $("#Stop").click(function(){
      if(timerOn()) stopTimer();
    });
  });

});
// webSocket heartbeat
// Server disconnect warning
</script>
</head>
<body>

<div id="login">
  <form id="loginForm">
    <input type="text" name="Employee" placeholder="Employee Number">
    <input type="text" name="CrewSize" placeholder="Crew Size">
    <input type="submit" value="Enter">
  </form>
</div>

<div id="working">
  Employee: <span id="Employee">0</span> <br>
  Completed: <span id="Completed">0</span> <br>
  Expected: <span id="Expected">0</span> <br>
  Actual PPH: <span id="ActualPPH">0</span> <br>
  Expected PPH: <span id="ExpectedPPH">0</span> <br>

  <div id="progressBar">
    <div id="progressFill">
    </div>
  </div>

  <button id="Part">Count Up</button><br>
  <button id="Start">Start</button><br>
  <button id="Stop">Stop</button><br>
</div>

</body>
</html>

