<html>
<head>
<style>
#progressBar {
  position: relative;
  width: 100%;
  height: 10px;
  background-color: #101090;
}
#progressFill {
  position: absolute;
  width: 10%;
  height: 100%;
  background-color: #4CAF50;
}
</style>
<script src="jquery.js"></script>
<script src="URI.js"></script>
<script>

function Timer(){
  this.elapsedTime = 0;
  this.triggerTime = 0;
  this.start = function() { this.triggerTime = Date.now(); };
  this.stop = function() {
    this.elapsedTime += this.getTime();
    this.triggerTime = 0;
  };
  this.getTime = function() {
    return (this.isOn())? (Date.now()-this.triggerTime) : 0;
  };
  this.getTotal = function() { return this.elapsedTime + this.getTime(); };
  this.isOn = function() { return (this.triggerTime != 0); }
}

function msToHours(ms){
  return (((ms/1000.0 /*seconds*/) / 60.0) /*minutes*/ / 60.0 /*hours*/);
}

var uri = new URI(window.location);
var MO = uri.search(true)["MO"];
var op = uri.search(true)["opnum"];

var partsLogged;
var expectedPPH;
var lastPart;
var timer;

function initializeJob(){
  partsLogged = 0
  expectedPPH = 0.0
  lastPart = 0
  timer = new Timer();
}

function logPart(){
  lastPart = Date.now();
  partsLogged += 1;
  updateCompleted();
}

function updateCompleted(){
  var hours = msToHours(timer.getTotal());

  $("#Completed").text(partsLogged);
  $("#ActualPPH").text(hours==0 ? 0.0 : (partsLogged/hours).toFixed(2) );
}

function updateExpected(){
  var hours = msToHours(timer.getTotal());
  var delta = msToHours(Date.now() - lastPart);
  var nextPartPercentage = Math.min(expectedPPH*delta, 1.0) * 100;

  $("#Expected").text((expectedPPH*hours).toFixed(0));
  $("#progressFill").width(timer.isOn() ? nextPartPercentage+'%' : 0);
}

function showStartup(){
  $("#login").show();
  $("#working").hide();
}

function hideStartup(){
  $("#login").hide();
  $("#working").show();
}

$(document).ready(function(){
  showStartup();

  $( "#loginForm" ).submit(function(event) {
    event.preventDefault();
    initializeJob();

    var emp = $(this).find("input[name='Employee']").val();
    var crw = $(this).find("input[name='CrewSize']").val();
    var socketAddress = "ws://"+location.hostname+":"+location.port+"/job?"
                        +$.param({MO: MO, opnum: op, empl: emp, crew: crw});

    // Update Employee field on the page
    $("#Employee").text(emp)

    // Start graphic update timer
    var refresh = window.setInterval(updateExpected, 50);

    //Startup the websocket. The first message will be the expected session PPH
    var webSocket = new WebSocket(socketAddress);
    var heartbeat = window.setInterval(function(){ webSocket.send(""); }, 10000);
    webSocket.onmessage = function (event) {
      expectedPPH = Number(event.data)
      $("#ExpectedPPH").text(expectedPPH)
      hideStartup();

      webSocket.onmessage = function (event) { console.log("Received "+data); }
    };
    webSocket.onclose = function(event) {
      showStartup();
      window.clearInterval(refresh);
      window.clearInterval(heartbeat);
      alert("Connection Failure");
    }

    var sendUpdate = function () {
      if(webSocket.readyState == WebSocket.OPEN)
        webSocket.send(
          JSON.stringify({count: partsLogged, elapsed: timer.getTotal()})
        );
    };

    $("#Part").click(function(){
      if(timer.isOn()){
        logPart();
        sendUpdate();
      }
    });
    $("#Toggle").click(function(){
      if(timer.isOn()){
        timer.stop();
        $(this).text("Start");
        $("#Part").prop("disabled",true);
      } else {
        timer.start();
        $(this).text("Stop");
        $("#Part").prop("disabled",false);
        lastPart = Date.now();
      }
    });
  });
});
// webSocket heartbeat
</script>
</head>
<body>

<div id="login">
  <form id="loginForm">
    <input type="text" name="Employee" placeholder="Employee Number">
    <input type="text" name="CrewSize" placeholder="Crew Size">
    <input type="submit" value="Enter">
  </form>
</div>

<div id="working">
  Employee: <span id="Employee">0</span> <br>
  Completed: <span id="Completed">0</span> <br>
  Expected: <span id="Expected">0</span> <br>
  Actual PPH: <span id="ActualPPH">0</span> <br>
  Expected PPH: <span id="ExpectedPPH">0</span> <br>

  <div id="progressBar">
    <div id="progressFill">
    </div>
  </div>

  <button id="Part" disabled>Count Up</button><br>
  <button id="Toggle">Start</button><br>
</div>

</body>
</html>

