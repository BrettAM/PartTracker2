<html>
<head>
<script src="jquery.js"></script>
<script src="URI.js"></script>
<script>
var uri = new URI(window.location);
var MO = uri.search(true)["MO"];
var op = uri.search(true)["opnum"];

function showStartup(){
  $("#login").show();
  $("#working").hide();
}

function hideStartup(){
  $("#login").hide();
  $("#working").show();
}

function updateCount(newCount){
  $("#Completed").text(newCount);
}

var PPH = 0.0
function updatePPH(newpph){
  PPH = newpph
  $("#ExpectedPPH").text(newpph)
}

$(document).ready(function(){
  showStartup();

  $( "#loginForm" ).submit(function(event) {
    event.preventDefault();
    var emp = $(this).find("input[name='Employee']").val();
    var crw = $(this).find("input[name='CrewSize']").val();
    var socketAddress = "ws://"+location.hostname+":"+location.port+"/job?"
                        +$.param({MO: MO, opnum: op, empl: emp, crew: crw});

    $("#Employee").text(emp)

    //Startup the websocket. The first message will be the expected session PPH
    var webSocket = new WebSocket(socketAddress);
    webSocket.onmessage = function (event) {
      updatePPH(event.data)
      hideStartup();
      //After the first message, all input is new count values
      webSocket.onmessage = function (event) { updateCount(event.data); }
    };
    webSocket.onclose = function(event) {
      showStartup();
      alert("Connection Failure");
    }

    $("#Part").click(function(){ webSocket.send("1") });
    $("#Start").click(function(){ webSocket.send("start") });
    $("#Stop").click(function(){ webSocket.send("stop") });
  });

});
// webSocket heartbeat
</script>
</head>
<body>

<div id="login">
  <form id="loginForm">
    <input type="text" name="Employee" placeholder="Employee Number">
    <input type="text" name="CrewSize" placeholder="Crew Size">
    <input type="submit" value="Enter">
  </form>
</div>

<div id="working">
  Employee: <span id="Employee">0</span> <br>
  Completed: <span id="Completed">0</span> <br>
  Expected: <span id="Expected">0</span> <br>
  Actual PPH: <span id="ActualPPH">0</span> <br>
  Expected PPH: <span id="ExpectedPPH">0</span> <br>
  <button id="Part">Count Up</button><br>
  <button id="Start">Start</button><br>
  <button id="Stop">Stop</button><br>
</div>

</body>
</html>

