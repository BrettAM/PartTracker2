<html>
<head>
<script src="jquery.js"></script>
<script>

function registerNewOperation(MO, number, dept, pph){
  $.post("operation", {MO: MO, opnum: number, dept: dept, PPH: pph}, function(data){
    if(data != "") alert(data);
    else populateMoTable(MO); //repopulate table after changes
  });
}

function workRedirect(MO, operation) {
  window.location = "work.html?"+$.param({MO: MO, opnum: operation})
}

function createRedirectButton(Name, mo, opNum) {
  return $('<button/>', {
    text: Name,
    click: function() { workRedirect(mo, opNum); }
  });
}

function populateMoTable(MOnumber) {
  $.get("mo", {MO: MOnumber}, function(data){
    console.log(data);
    if(data == "") {
      alert("MO does not exist");
      return;
    }

    // clear all but the first row of the table
    $("#operations").find("tr:gt(0)").remove()

    // Fill the table with this MO's data
    var ops = JSON.parse(data);
    var table = $('#operations').find('tbody');
    for(var i = 0; i < ops.length; i++){
      var op = ops[i]

      table.append($('<tr>')
        .append($('<td>').append(op.number))
        .append($('<td>').append(op.department))
        .append($('<td>').append(op.PPH))
        .append($('<td>').append(op.partsCompleted))
        .append($('<td>').append(op.truePPH.toFixed(2)))
        .append($('<td>').append(
            createRedirectButton('Work', MOnumber, op.number)
          )
        )
      );
    }

    //Make a row at the bottom with fields for registering operations
    var opNumber = $("<input type=\"text\"/>");
    var department = $("<input type=\"text\"/>");
    var partPerHour = $("<input type=\"text\"/>");
    var newOpButton = $('<button/>',{
      text: "Register",
      click: function () {
        registerNewOperation(
          MOnumber,
          opNumber.val(),
          department.val(),
          partPerHour.val()
        );
      }
    });
    table.append($('<tr>')
      .append($('<td>').append(opNumber))
      .append($('<td>').append(department))
      .append($('<td>').append(partPerHour))
      .append($('<td>'))
      .append($('<td>'))
      .append($('<td>').append(newOpButton))
    );
  });
}

$(document).ready(function(){
  $( "#MOsearch" ).submit(function(event) {
    event.preventDefault();
    var MO = $(this).find("input[name='MOnumber']").val();
    $.post("mo", {MO: MO}, function(data){ // Create the MO
      populateMoTable(MO);
    });
  });
});
</script>
</head>
<body>

<a href="active.html">Active sessions</a>

<div>
  <form action="/" id="MOsearch">
    Search MOs
    <input type="text" name="MOnumber" placeholder="MO#">
    <input type="submit" value="Enter">
  </form>
</div>

<table style="width:100%" id="operations">
  <tr>
    <td>Operation Number</td>
    <td>Department</td>
    <td>Spec PPH</td>
    <td>Completed</td>
    <td>Actual PPH</td>
    <td>Action</td>
  </tr>
</table>

</body>
</html>

