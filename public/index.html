<html>
<head>
<script src="jquery.js"></script>
<script>

function registerNewOperation(MO, number, dept, pph){
  $.post("operation", {MO: MO, opnum: number, dept: dept, PPH: pph}, function(data){
    if(data != "") alert(data);
    else populateMoTable(MO); //repopulate table after changes
  });
}

function populateMoTable(MOnumber) {
  $.get("mo", {MO: MOnumber}, function(data){
    console.log(data);
    if(data == "") {
      alert("MO does not exist");
      return;
    }

    // clear all but the first row of the table
    $("#operations").find("tr:gt(0)").remove()

    // Fill the table with this MO's data
    var ops = JSON.parse(data);
    var table = $('#operations').find('tbody');
    for(var i = 0; i < ops.length; i++){
      var mo = ops[i]
      var workButton = $('<button/>',{
        text: 'Work',
        click: function () { alert('start work'); }
      });

      table.append($('<tr>')
        .append($('<td>').append(mo.number))
        .append($('<td>').append(mo.department))
        .append($('<td>').append(mo.PPH))
        .append($('<td>').append(mo.partsCompleted))
        .append($('<td>').append(mo.truePPH))
        .append($('<td>').append(workButton))
      );
    }

    //Make a row at the bottom with fields for registering operations
    var opNumber = $("<input type=\"text\"/>");
    var department = $("<input type=\"text\"/>");
    var partPerHour = $("<input type=\"text\"/>");
    var newOpButton = $('<button/>',{
      text: "Register",
      click: function () {
        registerNewOperation(
          MOnumber,
          opNumber.val(),
          department.val(),
          partPerHour.val()
        );
      }
    });
    table.append($('<tr>')
      .append($('<td>').append(opNumber))
      .append($('<td>').append(department))
      .append($('<td>').append(partPerHour))
      .append($('<td>'))
      .append($('<td>'))
      .append($('<td>').append(newOpButton))
    );
  });
}

$(document).ready(function(){
/*  $( "#jobform" ).submit(function( event ) {
    // Stop form from submitting normally
    event.preventDefault();

    job = $(this).find( "input[name='jid']" ).val();
    console.log(job);

    window.location = "job.html?"+$.param({id: job});
  });*/

  $( "#MOsearch" ).submit(function(event) {
    event.preventDefault();
    var MO = $(this).find("input[name='MOnumber']").val();
    $.post("mo", {MO: MO}, function(data){ // Create the MO
      populateMoTable(MO);
    });
  });
});
</script>
</head>
<body>

<div>Enter MO#
  <form action="/" id="MOsearch">
    <input type="text" name="MOnumber" placeholder="#">
    <input type="submit" value="Enter">
  </form>
</div>

<table style="width:100%" id="operations">
  <tr>
    <td>Operation Number</td>
    <td>Department</td>
    <td>PPH</td>
    <td>Completed</td>
    <td>Actual PPH</td>
    <td>Action</td>
  </tr>
</table>

</body>
</html>

